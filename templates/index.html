<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자동 거래 관리 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            prefix: '', // React code uses default tailwind classes causing conflict? No, standard classes.
            // Bootstrap and Tailwind might conflict (preflight).
            // Usually disabling preflight or namespacing is needed. 
            // For now, let's try standard tailwind.
            corePlugins: {
                preflight: false, // Disable preflight to avoid breaking Bootstrap styles
            }
        }
    </script>
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
        }

        .form-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .table-container {
            margin-top: 30px;
        }

        .flash-messages {
            margin-bottom: 20px;
            /* position: sticky; */
            /* top: 0; */
            /* z-index: 1000; */
            /* background-color: white; */
            /* padding: 10px 0; */
            /* border-bottom: 1px solid #dee2e6; */
        }

        .editable-field {
            width: 80px;
            min-width: 70px;
            max-width: 100px;
            padding: 4px 6px;
            height: 32px;
        }

        .positive-profit {
            color: #198754;
            font-weight: bold;
        }

        .negative-profit {
            color: #dc3545;
            font-weight: bold;
        }

        .input-group-sm {
            max-width: 150px;
        }

        th {
            white-space: nowrap;
            /* 모든 th에 적용 */
            vertical-align: middle;
            /* 세로 정렬을 중앙으로 맞춤 */
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: #f8f9fa !important;
            /* Bootstrap table-light color */
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }

        td {
            vertical-align: middle;
        }

        /* Portfolio Allocation Styles */
        .portfolio-allocation {
            margin-top: 40px;
            margin-bottom: 40px;
        }

        .portfolio-summary {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .summary-card {
            padding: 15px;
            margin-bottom: 10px;
            text-align: center;
            border-radius: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .summary-label {
            font-size: 14px;
            color: #6c757d;
        }

        /* Chart Styles */
        .chart-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .chart-canvas {
            max-height: 400px;
        }

        .sticky-sub-header {
            position: sticky;
            top: 41px;
            z-index: 90;
            background-color: #cff4fc !important;
            /* table-info color */
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }

        /* This is important to keep the inactive rules visible */
        tbody.collapse.show {
            display: table-row-group !important;
            visibility: visible !important;
        }

        .positive-profit-soft {
            color: #198754;
            opacity: 0.6;
        }

        .negative-profit-soft {
            color: #dc3545;
            opacity: 0.6;
        }

        .positive-profit-bold {
            color: #198754;
            opacity: 1.0;
            font-weight: 700;
        }

        .negative-profit-bold {
            color: #dc3545;
            opacity: 1.0;
            font-weight: 700;
        }

        .neutral-profit {
            color: #6c757d;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mb-4">자동 거래 관리 시스템</h1>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages"
            style="position: sticky; top: 0; z-index: 1000; background-color: white; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        <div class="market-selector mb-4">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link {% if current_market == 'us' %}active{% endif %}" href="?market=us">미국 주식</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if current_market == 'kr' %}active{% endif %}" href="?market=kr">한국 주식</a>
                </li>
            </ul>
        </div>
        <!-- Portfolio Summary Section with Fixed Calculation -->
        <div class="portfolio-summary">
            <h3 class="text-center mb-4">포트폴리오 요약</h3>

            <div class="row">
                <div class="col-md-3">
                    <div class="summary-card bg-light">
                        <div class="summary-label">총 기여금</div>
                        <div class="summary-value font-monospace">
                            {% if is_kr_market %}
                            ₩{{ "{:,.0f}".format(total_contribution) }}
                            {% else %}
                            ${{ "{:,.2f}".format(total_contribution) }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card bg-light">
                        <div class="summary-label">총 자산 가치</div>
                        <div class="summary-value font-monospace">
                            {% if is_kr_market %}
                            ₩{{ "{:,.0f}".format(total_value) }}
                            {% else %}
                            ${{ "{:,.2f}".format(total_value) }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card bg-light">
                        <div class="summary-label">총 손익</div>
                        <div
                            class="summary-value font-monospace {% if total_profit >= 0 %}positive-profit{% else %}negative-profit{% endif %}">
                            {% if is_kr_market %}
                            ₩{{ "{:,.0f}".format(total_profit) }}
                            {% else %}
                            ${{ "{:,.2f}".format(total_profit) }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card bg-light">
                        <div class="summary-label">총 수익률</div>
                        <div
                            class="summary-value font-monospace {% if profit_percent >= 0 %}positive-profit{% else %}negative-profit{% endif %}">
                            {{ "{:,.2f}%".format(profit_percent) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="react-root" class="mb-4"></div>
        <script src="{{ url_for('static', filename='js/app.bundle.js') }}?v=3"></script>

        <!-- Daily Total Value Chart -->
        {% if daily_total_values %}
        <div class="chart-container">
            <h3 class="text-center mb-4">총 자산 추이 (전체 기간)</h3>
            <div class="alert alert-info">
                <small>
                    <i class="fas fa-info-circle"></i>
                    기간: {{ daily_total_values[0].record_date }} ~ {{ daily_total_values[-1].record_date }}
                    ({{ daily_total_values|length }}개 데이터 포인트)
                </small>
            </div>
            <div class="chart-canvas">
                <canvas id="totalValueChart"></canvas>
            </div>
        </div>
        {% endif %}

        <div class="table-container">
            <h3>종목별 포트폴리오 비중 (계좌 통합)</h3>
            {% if consolidated_allocations %}
            <div class="alert alert-info">
                전체 자금: {{ "${:,.2f}".format(total_value|float) }} ({{ consolidated_allocations|length }} 종목)
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th class="text-start" style="width: 1%; white-space: nowrap;">종목</th>
                        <th class="text-end ps-4" style="width: 1%; white-space: nowrap;">보유 수량</th>
                        <th class="text-end ps-4" style="width: 1%; white-space: nowrap;">평가금액</th>
                        <th class="text-end ps-4" style="width: 1%; white-space: nowrap;">비중 (%)</th>
                        <th class="text-center">그래프</th>
                    </tr>
                </thead>
                <tbody>
                    {% for allocation in consolidated_allocations %}
                    {% set is_significant = allocation.diff_percentage and allocation.diff_percentage|abs >= 1.0 %}
                    <tr>
                        <td class="text-start">
                            {% if allocation.symbol == 'cash' %}
                            <span class="badge bg-light text-dark">예수금</span>
                            {% else %}
                            <strong>{{ allocation.symbol }}</strong>
                            {% endif %}
                        </td>
                        <td class="text-end font-monospace ps-4" style="white-space: nowrap;">
                            {% if allocation.total_quantity %}
                            {% if allocation.diff_quantity and allocation.diff_quantity != 0 %}
                            {% if is_significant %}
                            <small
                                class="{% if allocation.diff_quantity > 0 %}positive-profit-bold{% else %}negative-profit-bold{% endif %} me-1"
                                style="font-size: 0.75em;">
                                {% else %}
                                <small
                                    class="{% if allocation.diff_quantity > 0 %}positive-profit-soft{% else %}negative-profit-soft{% endif %} me-1"
                                    style="font-size: 0.75em;">
                                    {% endif %}
                                    ({{ "{:+,.0f}".format(allocation.diff_quantity|float) if allocation.diff_quantity %
                                    1 == 0
                                    else "{:+,.4f}".format(allocation.diff_quantity|float) }})
                                </small>
                                {% endif %}
                                <span>
                                    {{ "{:,.0f}".format(allocation.total_quantity|float) if allocation.total_quantity %
                                    1 == 0
                                    else "{:,.4f}".format(allocation.total_quantity|float) }}
                                </span>
                                {% else %}
                                -
                                {% endif %}
                        </td>
                        <td class="text-end font-monospace ps-4" style="white-space: nowrap;">
                            {% if allocation.diff_value and allocation.diff_value != 0 %}
                            {% if is_significant %}
                            <small
                                class="{% if allocation.diff_value > 0 %}positive-profit-bold{% else %}negative-profit-bold{% endif %} me-1"
                                style="font-size: 0.75em;">
                                {% else %}
                                <small
                                    class="{% if allocation.diff_value > 0 %}positive-profit-soft{% else %}negative-profit-soft{% endif %} me-1"
                                    style="font-size: 0.75em;">
                                    {% endif %}
                                    ({{ "{:+,.2f}".format(allocation.diff_value|float) }})
                                </small>
                                {% endif %}
                                <span>{{ "${:,.2f}".format(allocation.total_value|float) }}</span>
                        </td>
                        <td class="text-end font-monospace ps-4" style="white-space: nowrap;">
                            {% if allocation.diff_percentage and allocation.diff_percentage != 0 %}
                            {% if is_significant %}
                            <small
                                class="{% if allocation.diff_percentage > 0 %}positive-profit-bold{% else %}negative-profit-bold{% endif %} me-1"
                                style="font-size: 0.75em;">
                                {% elif allocation.diff_percentage|abs <= 0.01 %} <small class="neutral-profit me-1"
                                    style="font-size: 0.75em;">
                                    {% else %}
                                    <small
                                        class="{% if allocation.diff_percentage > 0 %}positive-profit-soft{% else %}negative-profit-soft{% endif %} me-1"
                                        style="font-size: 0.75em;">
                                        {% endif %}
                                        ({{ "{:+.2f}%".format(allocation.diff_percentage|float) }})
                                    </small>
                                    {% endif %}
                                    <span>{{ "{:.2f}%".format(allocation.percentage|float) }}</span>
                        </td>
                        <td class="text-center">
                            <div class="progress" style="height: 24px;">
                                <div class="progress-bar
                                    {% if allocation.symbol == 'cash' %}bg-secondary
                                    {% elif allocation.percentage > 15 %}bg-danger
                                    {% elif allocation.percentage > 8 %}bg-warning
                                    {% else %}bg-success{% endif %}" role="progressbar"
                                    style="width: {{ allocation.percentage }}%;"
                                    aria-valuenow="{{ allocation.percentage }}" aria-valuemin="0" aria-valuemax="100">
                                    {% if allocation.percentage > 4 %}{{ "{:.1f}%".format(allocation.percentage|float)
                                    }}{% endif %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="alert alert-warning">
                종목별 포트폴리오 배분 데이터가 없습니다. 일별 기록이 생성된 후 확인할 수 있습니다.
            </div>
            {% endif %}
        </div>
        <!-- Account Table -->
        <div class="table-container">
            <h3>계정 목록</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th class="text-start">ID</th>
                        <th class="text-start">사용자 ID</th>
                        <th class="text-start">계좌번호</th>
                        <th class="text-start">설명</th>
                        <th class="text-start">타입</th>
                        <th class="text-end">예수금</th>
                        <th class="text-end">계좌총액</th>
                        <th class="text-end">기여금</th>
                        <th class="text-end">수익률</th>
                        <th class="text-start">최종 업데이트</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts %}
                    <tr>
                        <td class="text-start">{{ account.id }}</td>
                        <td class="text-start">{{ account.user_id }}</td>
                        <td class="text-start">
                            <span title="{{ account.account_number }}">
                                ****{{ account.account_number[-3:] }}
                            </span>
                        </td>
                        <td class="text-start">{{ account.description }}</td>
                        <td class="text-start">
                            <form action="{{ url_for('main.update_account_type') }}" method="post" class="d-inline">
                                <input type="hidden" name="market" value="{{ current_market }}">
                                <input type="hidden" name="account_id" value="{{ account.id }}">
                                <select name="account_type" class="form-select form-select-sm" style="width: 110px;"
                                    onchange="this.form.submit()">
                                    <option value="NORMAL" {% if account.account_type=='NORMAL' %}selected{% endif %}>일반
                                    </option>
                                    <option value="RETIREMENT" {% if account.account_type=='RETIREMENT' %}selected{%
                                        endif %}>은퇴</option>
                                    <option value="EXCLUDED" {% if account.account_type=='EXCLUDED' %}selected{% endif
                                        %}>제외</option>
                                </select>
                            </form>
                        </td>
                        <td class="text-end font-monospace">{{ "${:,.2f}".format(account.cash_balance|float) if
                            account.cash_balance else "$0" }}</td>
                        <td class="text-end font-monospace">{{ "${:,.2f}".format(account.total_value|float) if
                            account.total_value else "$0.00" }}</td>
                        <td class="text-end">
                            {% if current_market == 'kr' %}
                            <form action="{{ url_for('main.update_account_contribution') }}" method="post"
                                class="d-inline">
                                <input type="hidden" name="market" value="{{ current_market }}">
                                <input type="hidden" name="account_id" value="{{ account.id }}">
                                <div class="input-group input-group-sm justify-content-end">
                                    <span class="input-group-text">₩</span>
                                    <input type="number" class="form-control font-monospace text-end"
                                        name="contribution"
                                        value="{{ account.contribution|int if account.contribution else 0 }}"
                                        style="min-width: 80px;">
                                    <button type="submit" class="btn btn-outline-primary">
                                        <i class="fas fa-save"></i>
                                    </button>
                                </div>
                            </form>
                            {% else %}
                            <span class="font-monospace">
                                {% if account.contribution %}
                                {{ "${:,.2f}".format(account.contribution|float) }}
                                {% else %}
                                $0.00
                                {% endif %}
                            </span>
                            <button class="btn btn-sm btn-outline-info ms-2 view-history-btn"
                                data-account="{{ account.account_number }}" data-market="{{ current_market }}">
                                <i class="fas fa-list"></i>
                            </button>
                            {% endif %}
                        </td>
                        <td class="text-end font-monospace">
                            {% if account.contribution and account.contribution > 0 and account.total_value %}
                            {% set profit_percent = ((account.total_value - account.contribution) / account.contribution
                            * 100)|float %}
                            <span
                                class="{% if profit_percent >= 0 %}positive-profit{% else %}negative-profit{% endif %}">
                                {{ "{:.2f}%".format(profit_percent) }}
                            </span>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td class="text-start">{{ account.last_updated }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Trading Rules Table -->
        <!-- Trading Rules Table -->
        <div class="table-container">
            <h3>거래 규칙 목록</h3>

            <!-- Active Rules -->
            <h5 class="mt-4 mb-3 text-success"><i class="fas fa-check-circle"></i> 활성 규칙 ({{ active_rules|length }})
            </h5>
            <table class="table table-striped table-hover shadow-sm rounded">
                <thead class="table-light">
                    <tr>
                        <th class="text-start">ID</th>
                        <!-- Account Column Removed -->
                        {% if current_market == 'kr' %}
                        <th class="text-start">종목코드</th>
                        <th class="text-start">종목명</th>
                        {% else %}
                        <th class="text-start">종목</th>
                        {% endif %}
                        <th class="text-end">한계값</th>
                        <th class="text-end">목표 수량</th>
                        <th class="text-start">투자 액션</th>
                        <th class="text-end">일일 투자금</th>
                        <th class="text-center">현금만</th>
                        <th class="text-start">상태</th>
                        <th class="text-end">평균 매수가</th>
                        <th class="text-end">보유 수량</th>
                        <th class="text-end">종가</th>
                        <th class="text-end">수익률</th>
                        <th class="text-end">고점 대비</th>
                        <th class="text-center">작업</th>
                    </tr>
                </thead>

                <!-- Active Rules -->
                <tbody>
                    {% for rule in active_rules %}
                    {% if loop.first or rule.account_id != loop.previtem.account_id %}
                    <tr class="table-info">
                        <td colspan="20" class="fw-bold text-start ps-4 sticky-sub-header">
                            <i class="fas fa-user me-1"></i> {{ rule.user_id }}
                            <span class="mx-2">|</span>
                            <i class="fas fa-wallet me-1"></i> {{ rule.account_number }}
                            <span class="text-muted ms-2 fw-normal">({{ rule.account_description }})</span>
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="text-start">{{ rule.id }}</td>
                        <!-- Account TD Removed -->
                        <td class="text-start">{{ rule.symbol }}</td>
                        {% if current_market == 'kr' %}
                        <td class="text-start">{{ rule.stock_name }}</td>
                        {% else %}
                        {% endif %}
                        <td class="text-end">
                            <div class="d-flex align-items-center justify-content-end">
                                <form
                                    action="{{ url_for('main.update_rule_field', rule_id=rule.id, field='limit_value') }}"
                                    method="post" class="d-inline me-1">
                                    <input type="hidden" name="market" value="{{ current_market }}">
                                    <input type="number" step="0.01"
                                        class="form-control form-control-sm editable-field font-monospace text-end"
                                        name="value" value="{{ rule.limit_value }}" title="한계값" style="width: 100px;">
                                </form>
                                <form
                                    action="{{ url_for('main.update_rule_field', rule_id=rule.id, field='limit_type') }}"
                                    method="post" class="d-inline">
                                    <input type="hidden" name="market" value="{{ current_market }}">
                                    <select name="value" class="form-select form-select-sm"
                                        style="width: 70px; font-size: 0.8rem;">
                                        <option value="price" {% if rule.limit_type=='price' %}selected{% endif %}>가격
                                        </option>
                                        <option value="percent" {% if rule.limit_type=='percent' %}selected{% endif %}>%
                                        </option>
                                        <option value="high_percent" {% if rule.limit_type=='high_percent' %}selected{%
                                            endif %}>DIP %</option>
                                        <option value="weekly" {% if rule.limit_type=='weekly' %}selected{% endif %}>주간
                                            정기</option>
                                        <option value="monthly" {% if rule.limit_type=='monthly' %}selected{% endif %}>
                                            월간 정기</option>
                                    </select>
                                </form>
                            </div>
                        </td>
                        <td class="text-end">
                            <form
                                action="{{ url_for('main.update_rule_field', rule_id=rule.id, field='target_amount') }}"
                                method="post" class="d-inline">
                                <input type="hidden" name="market" value="{{ current_market }}">
                                <input type="number"
                                    class="form-control form-control-sm editable-field font-monospace text-end float-end"
                                    name="value" value="{{ rule.target_amount }}" title="목표 수량">
                            </form>
                        </td>
                        <td class="text-start">{% if rule.trade_action == 0 %}SELL{% elif rule.trade_action == 1
                            %}BUY{% else %}{{
                            rule.trade_action }}{% endif %}</td>
                        <td class="text-end">
                            <form action="{{ url_for('main.update_rule_field', rule_id=rule.id, field='daily_money') }}"
                                method="post" class="d-inline">
                                <input type="hidden" name="market" value="{{ current_market }}">
                                <input type="number" step="0.01"
                                    class="form-control form-control-sm editable-field font-monospace text-end float-end"
                                    name="value" value="{{ rule.daily_money }}" title="일일 투자금" style="width: 100%;">
                            </form>
                        </td>
                        <td class="text-center">
                            <form action="{{ url_for('main.update_rule_field', rule_id=rule.id, field='cash_only') }}"
                                method="post" class="d-inline">
                                <input type="hidden" name="market" value="{{ current_market }}">
                                <input type="checkbox" class="form-check-input" name="value" value="1" {% if
                                    rule.cash_only %}checked{% endif %}>
                            </form>
                        </td>
                        <td class="text-start">
                            <span
                                class="badge bg-{% if rule.status == 'ACTIVE' %}success{% elif rule.status == 'COMPLETED' %}primary{% elif rule.status == 'PROCESSED' %}info{% else %}secondary{% endif %}">
                                {{ rule.status }}
                            </span>
                        </td>
                        <td class="text-end font-monospace">{{ rule.average_price }}</td>
                        <td class="text-end font-monospace">{{ rule.current_holding }}</td>
                        <td class="text-end font-monospace">{{ rule.last_price }}</td>
                        <td class="text-end font-monospace">
                            {% if rule.average_price and rule.last_price and rule.average_price > 0 %}
                            {% set profit_percent = ((rule.last_price - rule.average_price) / rule.average_price *
                            100)|float %}
                            <span
                                class="{% if profit_percent >= 0 %}positive-profit{% else %}negative-profit{% endif %}">
                                {{ "{:.2f}%".format(profit_percent) }}
                            </span>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td class="text-end font-monospace">
                            {% if rule.last_price and rule.high_price and rule.high_price > 0 %}
                            {% set drop_percent = ((rule.high_price - rule.last_price) / rule.high_price * 100)|float %}
                            <span class="{% if drop_percent > 0 %}negative-profit{% else %}positive-profit{% endif %}">
                                {{ "{:.2f}%".format(drop_percent) }}
                            </span>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <form action="{{ url_for('main.update_rule_status', rule_id=rule.id) }}" method="post"
                                class="d-inline">
                                <input type="hidden" name="market" value="{{ current_market }}">
                                <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="">상태변경</option>
                                    <option value="ACTIVE">ACTIVE</option>
                                    <option value="PROCESSED">PROCESSED</option>
                                    <option value="COMPLETED">COMPLETED</option>
                                    <option value="CANCELLED">CANCELLED</option>
                                </select>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

                <!-- Inactive Rules Separator -->
                <tbody class="border-top" style="border-top-width: 3px !important; border-top-color: #dee2e6;">
                    <tr class="table-secondary clickable-row" data-bs-toggle="collapse"
                        data-bs-target="#inactive-rules-body" style="cursor: pointer;">
                        <td colspan="20" class="text-center fw-bold py-2 text-muted">
                            <i class="fas fa-chevron-down me-2"></i> 비활성 규칙 조회 ({{ inactive_rules|length }}) <i
                                class="fas fa-chevron-down ms-2"></i>
                        </td>
                    </tr>
                </tbody>

                <!-- Inactive Rules Body -->
                <tbody id="inactive-rules-body" class="collapse text-muted">
                    {% for rule in inactive_rules %}
                    {% if loop.first or rule.account_id != loop.previtem.account_id %}
                    <tr class="table-info">
                        <td colspan="20" class="fw-bold text-start ps-4 sticky-sub-header">
                            <i class="fas fa-user me-1"></i> {{ rule.user_id }}
                            <span class="mx-2">|</span>
                            <i class="fas fa-wallet me-1"></i> {{ rule.account_number }}
                            <span class="text-muted ms-2 fw-normal">({{ rule.account_description }})</span>
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="text-start">{{ rule.id }}</td>
                        <!-- Account TD Removed -->
                        <td class="text-start">{{ rule.symbol }}</td>
                        {% if current_market == 'kr' %}
                        <td class="text-start">{{ rule.stock_name }}</td>
                        {% else %}
                        {% endif %}
                        <td class="text-end">
                            <span class="font-monospace">{{ rule.limit_value }}</span>
                            <span class="badge bg-light text-dark border">{{ rule.limit_type }}</span>
                        </td>
                        <td class="text-end font-monospace">{{ rule.target_amount }}</td>
                        <td class="text-start">{% if rule.trade_action == 0 %}SELL{% elif rule.trade_action == 1
                            %}BUY{%
                            else %}{{
                            rule.trade_action }}{% endif %}</td>
                        <td class="text-end font-monospace">{{ rule.daily_money }}</td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input" disabled {% if rule.cash_only %}checked{%
                                endif %}>
                        </td>
                        <td class="text-start">
                            <span
                                class="badge bg-{% if rule.status == 'ACTIVE' %}success{% elif rule.status == 'COMPLETED' %}primary{% elif rule.status == 'PROCESSED' %}info{% else %}secondary{% endif %}">
                                {{ rule.status }}
                            </span>
                        </td>
                        <td class="text-end font-monospace">{{ rule.average_price }}</td>
                        <td class="text-end font-monospace">{{ rule.current_holding }}</td>
                        <td class="text-end font-monospace">{{ rule.last_price }}</td>
                        <td class="text-end font-monospace">
                            {% if rule.average_price and rule.last_price and rule.average_price > 0 %}
                            {% set profit_percent = ((rule.last_price - rule.average_price) /
                            rule.average_price *
                            100)|float %}
                            <span
                                class="{% if profit_percent >= 0 %}positive-profit{% else %}negative-profit{% endif %}">
                                {{ "{:.2f}%".format(profit_percent) }}
                            </span>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td class="text-end font-monospace">
                            {% if rule.last_price and rule.high_price and rule.high_price > 0 %}
                            {% set drop_percent = ((rule.high_price - rule.last_price) / rule.high_price
                            * 100)|float %}
                            <span class="{% if drop_percent > 0 %}negative-profit{% else %}positive-profit{% endif %}">
                                {{ "{:.2f}%".format(drop_percent) }}
                            </span>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <form action="{{ url_for('main.update_rule_status', rule_id=rule.id) }}" method="post"
                                class="d-inline">
                                <input type="hidden" name="market" value="{{ current_market }}">
                                <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="">상태변경</option>
                                    <option value="ACTIVE">ACTIVE</option>
                                    <option value="PROCESSED">PROCESSED</option>
                                    <option value="COMPLETED">COMPLETED</option>
                                    <option value="CANCELLED">CANCELLED</option>
                                </select>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>


        </div>
        <div class="row">
            <!-- Account Form -->
            <div class="col-md-6">
                <div class="form-container">
                    <h3>계정 추가</h3>
                    <form action="{{ url_for('main.add_account') }}" method="post">
                        <input type="hidden" name="market" value="{{ current_market }}">
                        <div class="mb-3">
                            <label for="user_id" class="form-label">사용자 ID</label>
                            <input type="text" class="form-control" id="user_id" name="user_id" required>
                        </div>
                        <div class="mb-3">
                            <label for="account_number" class="form-label">계좌번호</label>
                            <input type="text" class="form-control" id="account_number" name="account_number" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">설명</label>
                            <input type="text" class="form-control" id="description" name="description" required>
                        </div>
                        <button type="submit" class="btn btn-primary">계정 추가</button>
                    </form>
                </div>
            </div>

            <!-- Trading Rule Form -->
            <div class="col-md-6">
                <div class="form-container">
                    <h3>거래 규칙 추가</h3>
                    <form action="{{ url_for('main.add_trading_rule') }}" method="post">
                        <input type="hidden" name="market" value="{{ current_market }}">
                        <div class="mb-3">
                            <label for="account_id" class="form-label">계정 선택</label>
                            <select class="form-select" id="account_id" name="account_id" required>
                                <option value="">계정을 선택하세요</option>
                                {% for account in accounts %}
                                <option value="{{ account.id }}">{{ account.id }} - {{ account.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="symbol" class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="symbol" name="symbol" required>
                        </div>
                        {% if current_market == 'kr' %}
                        <div class="mb-3">
                            <label for="stock_name" class="form-label">종목명</label>
                            <input type="text" class="form-control" id="stock_name" name="stock_name" required>
                        </div>
                        {% else %}

                        {% endif %}
                        <div class="mb-3">
                            <label for="trade_action" class="form-label">액션 선택</label>
                            <select class="form-select" id="trade_action" name="trade_action" required>
                                <option value="">액션을 선택하세요</option>
                                <option value="1">BUY</option>
                                <option value="0">SELL</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="limit_value" class="form-label">한계값</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" id="limit_value"
                                    name="limit_value" required>
                                <select class="form-select" id="limit_type" name="limit_type" style="max-width:100px;">
                                    <option value="price">가격</option>
                                    <option value="percent">%</option>
                                    <option value="high_percent">DIP %</option>
                                    <option value="weekly">주간 정기</option>
                                    <option value="monthly">월간 정기</option>
                                </select>
                            </div>
                            <div class="form-text">가격(예: 100.00) / 퍼센트(예: 5.0) / 주간: 0(월)~6(일) / 월간: 1~31 중 선택</div>
                        </div>

                        <div class="mb-3">
                            <label for="target_amount" class="form-label">목표 수량</label>
                            <input type="number" class="form-control" id="target_amount" name="target_amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="daily_money" class="form-label">일일 투자금</label>
                            <input type="number" step="0.01" class="form-control" id="daily_money" name="daily_money"
                                required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="cash_only" name="cash_only" {% if
                                    current_market=='kr' %}checked{% endif %}>
                                <label class="form-check-label" for="cash_only">현금 잔고 내에서만 매수</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">거래 규칙 추가</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Transaction History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="historyLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="historyContent" style="display:none;">
                        <h6 id="historyAccountTitle"></h6>
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // limit_type 변경 시 입력 필드 유효성 검사
        document.addEventListener('DOMContentLoaded', function () {
            const limitTypeSelect = document.getElementById('limit_type');
            const limitValueInput = document.getElementById('limit_value');

            if (limitTypeSelect && limitValueInput) {
                limitTypeSelect.addEventListener('change', function () {
                    if (this.value === 'weekly') {
                        limitValueInput.placeholder = '요일 (0:월 ~ 6:일)';
                        limitValueInput.min = 0;
                        limitValueInput.max = 6;
                        limitValueInput.step = 1;
                    } else if (this.value === 'monthly') {
                        limitValueInput.placeholder = '날짜 (1 ~ 31)';
                        limitValueInput.min = 1;
                        limitValueInput.max = 31;
                        limitValueInput.step = 1;
                    } else if (this.value === 'percent' || this.value === 'high_percent') {
                        limitValueInput.placeholder = '예: 5.0 (5% 낮은 가격으로 매수, 5% 높은 가격으로 매도)';
                        limitValueInput.step = '0.01';
                    } else {
                        limitValueInput.placeholder = '예: 100.00';
                        limitValueInput.step = '0.01';
                    }
                });
            }

            // 스크롤 위치 유지를 위한 AJAX 폼 제출 처리
            function handleFormSubmit(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);
                const currentScrollPosition = window.scrollY;

                const flashMessagesContainer = document.querySelector('.flash-messages');

                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            window.scrollTo(0, currentScrollPosition);

                            flashMessagesContainer.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <strong>성공!</strong> 값이 업데이트되었습니다.
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;

                            // 3초 후 메시지 자동 제거
                            setTimeout(() => {
                                flashMessagesContainer.innerHTML = '';
                            }, 3000);
                        } else {
                            throw new Error(`Network response was not ok: ${response.status}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);

                        // 에러 시 메시지 표시
                        flashMessagesContainer.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>오류!</strong> 값 업데이트에 실패했습니다.
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;

                        setTimeout(() => {
                            flashMessagesContainer.innerHTML = '';
                        }, 3000);
                    });
            }

            // 모든 업데이트 폼에 대해 AJAX 처리 적용
            const updateForms = document.querySelectorAll('form[action*="update_field"], form[action*="update_account_contribution"], form[action*="update_account_type"]');

            updateForms.forEach(form => {
                // 폼 제출 이벤트 리스너 추가
                form.addEventListener('submit', handleFormSubmit);

                // 입력 필드에 change 이벤트 리스너 추가
                const changeInputs = form.querySelectorAll('input[type="number"], input[type="text"], select, input[type="checkbox"]');
                changeInputs.forEach(input => {
                    input.addEventListener('change', (event) => {
                        // 변경된 input 정보를 이벤트에 추가
                        const submitEvent = new Event('submit');
                        submitEvent.changedInput = event.target;
                        form.dispatchEvent(submitEvent);
                    });
                });
            });

            // History Modal Logic
            const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            const historyContent = document.getElementById('historyContent');
            const historyLoading = document.getElementById('historyLoading');
            const historyTableBody = document.getElementById('historyTableBody');
            const historyAccountTitle = document.getElementById('historyAccountTitle');

            document.querySelectorAll('.view-history-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const accountNum = this.getAttribute('data-account');
                    const market = this.getAttribute('data-market');

                    historyAccountTitle.textContent = `Account: ${accountNum}`;
                    historyLoading.style.display = 'block';
                    historyContent.style.display = 'none';
                    historyTableBody.innerHTML = '';
                    historyModal.show();

                    fetch(`/api/history/${accountNum}?market=${market}`)
                        .then(response => response.json())
                        .then(data => {
                            historyLoading.style.display = 'none';
                            historyContent.style.display = 'block';

                            if (data.history && data.history.length > 0) {
                                data.history.forEach(tx => {
                                    const row = document.createElement('tr');
                                    // Formatting amount
                                    let amt = parseFloat(tx.amount);
                                    let formattedAmt = amt.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                    // Simple styling
                                    let amtClass = amt >= 0 ? 'text-success' : 'text-danger';

                                    row.innerHTML = `
                                        <td>${tx.transaction_date.substring(0, 10)}</td>
                                        <td>${tx.type}</td>
                                        <td class="${amtClass}">${formattedAmt}</td>
                                        <td class="small text-muted">${tx.description}</td>
                                    `;
                                    historyTableBody.appendChild(row);
                                });
                            } else {
                                historyTableBody.innerHTML = '<tr><td colspan="4" class="text-center">No history found.</td></tr>';
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            historyLoading.style.display = 'none';
                            historyTableBody.innerHTML = `<tr><td colspan="4" class="text-danger">Error loading history: ${err}</td></tr>`;
                            historyContent.style.display = 'block';
                        });
                });
            });

            // Inactive Rules State Persistence
            function restoreInactiveState() {
                const el = document.getElementById('inactive-rules-body');
                const triggers = document.querySelectorAll('[data-bs-target="#inactive-rules-body"]');
                const isOpen = localStorage.getItem('inactiveRulesOpen') === 'true';

                if (el) {
                    if (isOpen) {
                        el.classList.add('show');
                        triggers.forEach(t => {
                            t.classList.remove('collapsed');
                            t.setAttribute('aria-expanded', 'true');
                        });
                    } else {
                        el.classList.remove('show');
                        triggers.forEach(t => {
                            t.classList.add('collapsed');
                            t.setAttribute('aria-expanded', 'false');
                        });
                    }
                }
            }

            // Initial Check
            restoreInactiveState();

            // Toggle Listener (Delegated)
            document.addEventListener('click', function (e) {
                const target = e.target.closest('[data-bs-target="#inactive-rules-body"]');
                if (target) {
                    setTimeout(() => {
                        const el = document.getElementById('inactive-rules-body');
                        if (el) {
                            const isOpen = el.classList.contains('show');
                            localStorage.setItem('inactiveRulesOpen', isOpen);
                        }
                    }, 350); // Delay for Bootstrap transition
                }
            });

            // Observer for AJAX updates
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                const observer = new MutationObserver(function (mutations) {
                    restoreInactiveState();
                });
                observer.observe(tableContainer, { childList: true, subtree: true });
            }
    </script>
    <!-- Chart.js Script -->
    {% if daily_total_values %}
    <script>
            // 차트 데이터 준비
            const dailyData = {{ daily_total_values | tojson
        }};

        const labels = dailyData.map(item => item.record_date);
        const values = dailyData.map(item => parseFloat(item.total_value));

        // Canvas 요소 확인
        const canvas = document.getElementById('totalValueChart');

        if (!canvas) {
            console.error('Canvas element not found!');
        } else {
            // 차트 설정
            const ctx = canvas.getContext('2d');

            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '총 자산 가치',
                        data: values,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1,
                        pointBackgroundColor: 'rgb(75, 192, 192)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '날짜'
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '자산 가치 ($)'
                            },
                            ticks: {
                                callback: function (value, index, values) {
                                    // 'is_kr_market' 변수를 사용하여 원화(₩) 또는 달러($)를 동적으로 표시
                                    {% if is_kr_market %}
                                    return '₩' + value.toLocaleString();
                                    {% else %}
                                        return '$' + value.toLocaleString();
                                    {% endif %}
        }
                            }
                        }
                    },
        elements: {
            point: {
                hoverRadius: 8
            }
        }
                }
            };

        try {
            const totalValueChart = new Chart(ctx, chartConfig);
        } catch (error) {
            console.error('Error creating chart:', error);
        }
        }
    </script>
    {% else %}
    <script>
        console.log('No daily_total_values data available');
    </script>
    {% endif %}
</body>

</html>